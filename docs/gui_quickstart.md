# GUI クイックスタート

## 概要

`gui/main.py` は PySide6 製の GUI で、以下の操作を画面から実行できます。

| ボタン | 実行内容 |
|--------|----------|
| **Update (RACE)** | JV-Link から過去データを取得 (32-bit Python) → 派生テーブルを更新 (64-bit) |
| **Suggest** | 複勝買い目提案を一括生成 (64-bit) |
| **Update + Suggest** | Update → Suggest を連続して実行 |
| **キャンセル** | 実行中のプロセスを停止してキューをクリア |
| **複勝モデル再学習** | build_tables_from_raw → build_place_training_data → train_place_model を連続実行 |
| **ワイドモデル再学習** | build_wide_training_data → train_wide_model を連続実行 |
| **3連複モデル再学習** | build_sanrenpuku_training_data → train_sanrenpuku_model を連続実行 |
| **全部再学習** | 複勝 → ワイド → 3連複 の順に全モデルを再学習 |

---

## 前提条件

| 要件 | 備考 |
|------|------|
| Windows | JV-Link COM コンポーネントが必要 |
| Python 32-bit | `jv_ingest_raw.py` は 32-bit で実行する必要あり |
| Python 64-bit venv | `pandas` / `catboost` 等のライブラリが入っている venv |
| JV-Link | `JVDTLab.JVLink` COM コンポーネントが登録済みであること |

---

## セットアップ

### 1. 64-bit venv に PySide6 をインストール

```powershell
# 64-bit venv をアクティブにしてから
pip install PySide6
```

依存関係は `requirements.txt` からまとめてインストールできます:

```powershell
pip install -r requirements.txt
```

### 2. 32-bit Python に pywin32 をインストール

```powershell
# 32-bit の python.exe を使って
C:\Python32\python.exe -m pip install pywin32
```

---

## 起動方法

```powershell
# リポジトリのルートディレクトリで
# 64-bit venv をアクティブにしてから
python gui/main.py
```

---

## 自動設定とデフォルト値

初回起動時 (設定ファイルが存在しない場合) に以下を自動で検出・設定します:

| 項目 | 自動設定内容 |
|------|-------------|
| DB パス | `<リポジトリルート>/jv_data.db` |
| モデルパス | `<リポジトリルート>/models/place_model.cbm` |
| 出力ディレクトリ | `<リポジトリルート>/out` (存在しない場合は自動作成) |
| 32-bit Python | `py` ランチャー または 一般的なインストールパスを自動検出 |

32-bit Python が自動検出できない場合は警告が表示されます。「検出」ボタンで再検出を試みるか、`…` ボタンで手動選択してください。

---

## 設定の永続化

設定はリポジトリルートの `.keiba_gui_config.json` に自動保存され、次回起動時に復元されます。  
このファイルはローカルの設定のみを含むため、`.gitignore` に登録されておりバージョン管理の対象外です。

保存される設定:
- DB パス / モデルパス / 出力ディレクトリ
- 32-bit Python コマンド
- 最後に使用した取込開始日
- レースキー
- 検索キーワード・週末メインレースフィルタ
- ウィンドウの位置とサイズ

---

## 各入力項目

| 項目 | デフォルト | 説明 |
|------|-----------|------|
| DB パス | `<repo>/jv_data.db` | SQLite DB ファイルのパス |
| 取込開始日 | 今日の日付 | カレンダーから選択。`YYYYMMDD` 形式で渡される。Update ボタン用 |
| 出力ディレクトリ | `<repo>/out` | Suggest の出力先ディレクトリ |
| モデルパス | `<repo>/models/place_model.cbm` | 学習済み CatBoost モデル |
| 32-bit Python | (自動検出) | 32-bit Python の実行コマンド。`py -3.11-32` または `python.exe` フルパス |
| レースキー (手動) | (空) | スペース区切りのレースキー。テーブルでレースを選択していない場合の手動フォールバック |

`…` ボタンを押すとファイル/フォルダ選択ダイアログが開きます。  
取込開始日はカレンダーアイコンをクリックしてカレンダーから選択できます。

---

## レース選択 (推奨ワークフロー)

レースキーを手入力する代わりに、GUI からレースを検索・選択できます。

### 重賞レースを素早く読み込む

1. **取込開始日** を対象レース日に設定します。
2. **「重賞レースを読み込む」** ボタンを押します。
   - `place_odds のみ` チェックボックスがオンの場合、place_odds データが存在するレースのみ表示されます (デフォルト: オン)。
   - grade_code A/B/C の重賞レースがテーブルに表示されます。

### キーワード・週末メインレースで検索する

1. **取込開始日** を対象レース日に設定します。
2. **「キーワード」** 欄にレース名の一部を入力します (空白でも検索可)。
3. 必要に応じて **「週末メイン (R≥10)」** チェックボックスをオンにします。
   - オンにすると race_no が 10 以上 (その日のメイン競走) のレースのみ表示されます。
4. **「検索」** ボタンを押します (またはキーワード欄で Enter キーを押します)。
5. テーブルの **✓ 列のチェックボックス** で対象レースを選択します (複数選択可)。
6. 下記いずれかで Suggest を実行します:
   - **そのまま「Suggest」または「Update + Suggest」を押す** — テーブルで選択中のレースキーが自動的に使われます。
   - **「選択したレースをキーに設定」** ボタンを押してレースキー欄に転記してから実行する。

テーブルで何も選択されていない場合は、「レースキー (手動)」欄の値が使用されます。

---

## 予想結果の確認 (インアプリビューア)

Suggest 実行後、出力ディレクトリの結果を GUI 内で確認できます。

### 自動更新

Suggest / Update+Suggest が正常完了すると、**予想結果セクションが自動的に更新**されます。

### 手動更新

「**結果を更新**」ボタンを押すと、出力ディレクトリの `summary.csv` を読み込んでサマリーテーブルを更新します。

### サマリーテーブルの見方

| 列 | 内容 |
|----|------|
| レース名 | DB のレース名 (取得できない場合は race_key) |
| 競馬場 | 競馬場コード |
| R | レース番号 |
| S | ステータス (ok / failed) |
| 買い目数 | 購入点数 |
| 賭金計 | 合計賭け金 |
| 期待値計 | 合計期待値 (円) |
| avg p | 平均複勝圏確率 |
| F/B | フォールバック使用フラグ |

### レースヘッダー

サマリーテーブルの行を選択すると、詳細エリアの上部に以下の情報を含む**レースヘッダーラベル**が表示されます:

```
日付  |  競馬場  |  R番号  |  レース名  |  グレード  |  距離(m)  |  馬場  |  出走N頭
```

DB から取得できない場合は race_key がそのまま表示されます。

### 詳細の確認

サマリーテーブルの行をクリックすると、選択レースの **買い目テーブル** と **予測テーブル** が下に展開されます。

### 買い目テーブルの表示/非表示

予測分析に集中したいときは「**買い目を隠す**」ボタンを押すと買い目テーブルを非表示にできます。再度押すと表示に戻ります。

### 予測テーブルの見方 (分析モード)

予測テーブルは p_place (複勝圏確率) **降順**で自動的にソートされます。DB に結果データがある場合、以下の追加列が表示されます:

| 列 | 内容 |
|----|------|
| 順位 | p_place 降順での予測ランク |
| 馬番 | 馬番号 |
| 馬名 | 馬名 (horses テーブルが利用可能な場合。未登録の場合は horse_id を表示) |
| 騎手名 | 騎手名 (jockeys テーブルが利用可能な場合) |
| 調教師名 | 調教師名 (trainers テーブルが利用可能な場合) |
| p_place | 予測複勝圏確率 (4桁) |
| 着順 | 実際の着順 (結果が確定している場合) |
| 複勝圏 | ✓ = 実際に複勝圏入り / ✗ = 圏外 / (空) = 未確定 |
| TP | ✓ = 真陽性 (予測上位かつ実際に複勝圏入り)。行は**緑色**でハイライト |

### 分析用フィルタ・コントロール

予測テーブルの上部に以下のフィルタがあります:

| コントロール | 説明 |
|------------|------|
| **上位表示** (スピンボックス) | 0 = 全て表示 / N = 予測上位N頭のみ表示 (デフォルト: 8) |
| **複勝圏のみ** チェックボックス | 実際に複勝圏に入った馬のみ表示 (結果確定後の分析に便利) |
| **オッズあり馬のみ** チェックボックス | place_odds テーブルにオッズが存在する馬のみ表示 |

フィルタはリアルタイムで適用されます (ファイルの再読み込みは不要)。

### 出力フォルダを開く

「**出力フォルダを開く**」ボタンを押すと、OS のファイルマネージャーで出力ディレクトリが開きます。

---

## Update (RACE) の動作

1. **Step 1/2** — `scripts/jv_ingest_raw.py` を **32-bit Python** で実行:
   ```
   <python32> scripts/jv_ingest_raw.py --from-date <日付> --dataspec RACE --db <DB>
   ```
2. **Step 2/2** — `scripts/update_db_from_raw.py` を **64-bit Python (現在の venv)** で実行:
   ```
   python scripts/update_db_from_raw.py --db <DB> --skip-masters
   ```

Step 1 が失敗した場合、Step 2 は実行されません。

---

## Suggest の動作

`scripts/batch_suggest_place_bets.py` を **64-bit Python** で実行:

```
python scripts/batch_suggest_place_bets.py \
    --db <DB> --model <モデル> --out-dir <出力ディレクトリ> \
    --race-keys <レースキー1> <レースキー2> ...
```

出力 CSV は `<出力ディレクトリ>/summary.csv` に生成されます。  
各レースの予測 JSON は `pred_<race_key>.json`、買い目 JSON は `bets_<race_key>.json` として出力されます。

---

## モデル再学習

「**再学習**」セクションを展開してモデルを再学習できます。

### 再学習パス設定

| 項目 | デフォルト | 説明 |
|------|-----------|------|
| 複勝学習CSV出力 | `<repo>/data/place_train.csv` | 複勝学習データの出力先 |
| 複勝モデル出力 | `<repo>/models/place_model.cbm` | 複勝モデルの出力先 |
| ワイド学習CSV出力 | `<repo>/data/wide_train.csv` | ワイド学習データの出力先 |
| ワイドモデル出力 | `<repo>/models/wide_model.cbm` | ワイドモデルの出力先 |
| 3連複学習CSV出力 | `<repo>/data/sanrenpuku_train.csv` | 3連複学習データの出力先 |
| 3連複モデル出力 | `<repo>/models/sanrenpuku_model.cbm` | 3連複モデルの出力先 |

### 複勝モデル再学習

1. 「**複勝モデル再学習**」ボタンを押します。
2. 確認ダイアログで「Yes」を選択します。
3. 以下のスクリプトが順に実行されます:
   1. `build_tables_from_raw.py` — 正規化テーブルを最新化
   2. `build_place_training_data.py` — 学習データ CSV を生成
   3. `train_place_model.py` — CatBoost で複勝モデルを学習

予想所要時間: データ量によりますが数分〜30分程度。

### ワイドモデル再学習

1. 「**ワイドモデル再学習**」ボタンを押します。
2. 確認ダイアログで「Yes」を選択します。
3. 以下のスクリプトが順に実行されます:
   1. `build_wide_training_data.py` — 全ペアの学習データ CSV を生成 (`data/wide_train.csv`)
   2. `train_wide_model.py` — CatBoost でワイドモデルを学習 (`models/wide_model.cbm`)

予想所要時間: 複勝より長く、10分〜1時間程度 (ペア数は馬数の二乗に比例)。

### 3連複モデル再学習

1. 「**3連複モデル再学習**」ボタンを押します。
2. 確認ダイアログで「Yes」を選択します。
3. 以下のスクリプトが順に実行されます:
   1. `build_sanrenpuku_training_data.py` — 全トリプルの学習データ CSV を生成 (`data/sanrenpuku_train.csv`)
   2. `train_sanrenpuku_model.py` — CatBoost で3連複モデルを学習 (`models/sanrenpuku_model.cbm`)

予想所要時間: ワイドよりさらに長く、30分〜数時間程度 (トリプル数は馬数の三乗に比例)。

### 全部再学習

「**全部再学習**」ボタンを押すと、複勝 → ワイド → 3連複 の順に全モデルを再学習します。  
内部では `build_tables_from_raw.py` が最初に一度だけ実行されます。

---

## 馬名マスタ (horses テーブル)

予測テーブルの「馬名」列には `horses` テーブルの馬名が表示されます。  
`horses` テーブルが存在しない場合や該当する馬が登録されていない場合は horse_id がそのまま表示されます。

### horses テーブルの構築方法

`horses` テーブルは SE レコード (馬毎レース情報) の馬名フィールドから構築します。  
以下の 2 通りの方法があります:

#### 方法 1: build_tables_from_raw.py を実行する (推奨)

`scripts/build_tables_from_raw.py` は SE レコードを処理する際に自動的に `horses` テーブルも更新します:

```powershell
python scripts/build_tables_from_raw.py --db jv_data.db
```

#### 方法 2: jv_ingest_horses.py を単独で実行する

既に `raw_jv_records` に SE レコードが取り込まれている場合は、専用スクリプトで馬名マスタのみを更新できます:

```powershell
python scripts/jv_ingest_horses.py --db jv_data.db
```

### horses テーブルのスキーマ

| 列 | 型 | 説明 |
|----|-----|------|
| horse_id | TEXT PRIMARY KEY | 血統登録番号 (KettoNum) |
| horse_name | TEXT NOT NULL | 馬名 (Bamei) |
| updated_at | TEXT NOT NULL | 最終更新日時 (ISO 8601) |

---

## ログ

ウィンドウ下部のログエリアに各コマンドの標準出力がリアルタイムで表示されます。  
「ログをクリア」ボタンでログを消去できます。

---

## 当日入力（手動予測）

JV-Link データが取得できない場合でも、レース条件と出走馬を手動入力して複勝圏確率 (p_place) を予測できます。  
「当日入力（手動予測）」セクションを展開して使用します。

### 必要なデータ

**レース条件 (すべて必須):**

| 項目 | 説明 |
|------|------|
| 競馬場コード | ドロップダウンから選択 (例: 東京 (05), 中山 (06))。コードを直接入力することも可能 |
| 距離 (m) | レースの施行距離。数値を直接入力するか、**距離プリセット**ドロップダウン (「選択」隣) から一般的な距離を選択可能。プリセット選択時は自動的にスピンボックスの値が更新されます |
| 馬場状態 | 良 / 稍重 / 重 / 不良 から選択 |
| 馬場種別 (芝/ダート) | 芝 / ダート / サンド / 障害 / 不明 から選択。モデルが `surface` 特徴量に対応している場合は**必須**。対応していない場合は任意 (予測に影響しません) |
| グレードコード | 任意。例: `A`, `B`, `C`, `15` (通常競走) |

**出走馬 (1 頭ごとに必須):**

| 項目 | 説明 |
|------|------|
| 馬番 | 1〜20 のドロップダウンから選択 |
| 馬名 | `horses` テーブルがある場合はドロップダウン。ない場合は horse_id を直接入力 |
| 騎手 | `jockeys` / `jockey_aliases` テーブルがある場合はドロップダウン。ない場合は騎手コードを直接入力 |
| 調教師 | `trainers` / `trainer_aliases` テーブルがある場合はドロップダウン。ない場合は調教師コードを直接入力 |
| 斤量 (kg) | 数値 (例: `57.5`) |
| **馬体重 (kg)** | **必須**。整数 (例: `480`) |

### 手順

1. **「マスタ読み込み」** ボタンを押して DB から馬・騎手・調教師マスタを読み込みます。
   - `horses` / `jockeys` / `trainers` テーブルがない場合、または 0 件の場合は自動でフリーテキスト入力または別名テーブル (`jockey_aliases` / `trainer_aliases`) にフォールバックします。
2. **「行追加」** ボタンを押して出走馬の入力行を追加します。
3. 各行に馬番・馬名・騎手・調教師・斤量・**馬体重** を入力します。
   - **馬名を選択すると**、`horse_latest_metrics` テーブル (または `entries` テーブルの最新データ) を参照し、**斤量と馬体重が自動入力**されます。
   - 自動入力はフィールドが空の場合のみ行われます。既に入力された値は上書きされません。
4. **「予測」** ボタンを押します。
5. 未入力の必須フィールドがある場合、ダイアログでエラー内容を確認して修正してください。  
   **馬体重が未入力の場合は予測がブロックされます。**
6. 予測が完了すると「予想結果」セクションの予測テーブルに p_place 降順で結果が表示されます。
7. 予測 JSON (`pred_manual_<タイムスタンプ>.json`) が出力ディレクトリに保存されます。

### バリデーション仕様

- 競馬場コード・距離・出走馬1頭以上は必須です。
- 各出走行の馬番・馬名/horse_id・騎手・調教師・斤量・**馬体重** はすべて必須です。**馬番はドロップダウンから選択してください。**
- **馬体重 (`body_weight`) が未入力の場合は予測を実行できません**。モデルの主要特徴量のため省略不可です。
- **馬場種別 (`surface`)** は `races` テーブルの `surface` 列から自動導出されます (トラックコード2009 → 芝/ダート/サンド/障害/不明)。現在のモデルは `surface` 特徴量に対応しているため、手動予測時は**必須**です。
- エラーがある場合はダイアログに一覧表示され、予測は実行されません。

### フォールバック動作

| テーブル | 状態 | フォールバック |
|----------|------|---------------|
| `horses` | ✓ (1件以上) | 馬名ドロップダウンを表示 |
| `horses` | ✗ | horse_id を直接入力するテキストフィールドを表示 |
| `jockeys` | ✓ (1件以上) | 騎手名ドロップダウンを表示 (`名前 (コード)` 形式) |
| `jockeys` | 0件 または ✗ | `jockey_aliases` テーブルを試みる |
| `jockey_aliases` | ✓ (1件以上) | 騎手名ドロップダウンを表示 (`名前 (コード)` 形式) |
| `jockey_aliases` | 0件 または ✗ | 騎手コードを直接入力するテキストフィールドを表示 |
| `trainers` | ✓ (1件以上) | 調教師名ドロップダウンを表示 (`名前 (コード)` 形式) |
| `trainers` | 0件 または ✗ | `trainer_aliases` テーブルを試みる |
| `trainer_aliases` | ✓ (1件以上) | 調教師名ドロップダウンを表示 (`名前 (コード)` 形式) |
| `trainer_aliases` | 0件 または ✗ | 調教師コードを直接入力するテキストフィールドを表示 |

### 注意事項

- 騎手・調教師のコードは DB のコード体系に合わせてください (モデルが学習したコードと一致する必要があります)。
- 結果は「予想結果」セクションの予測テーブルに表示されます。「複勝圏のみ」「オッズあり馬のみ」フィルタは  
  オフにしてご確認ください (当日入力では結果・オッズデータが存在しないため)。
