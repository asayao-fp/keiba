# GUI クイックスタート

## 概要

`gui/main.py` は PySide6 製の GUI で、以下の操作を画面から実行できます。

| ボタン | 実行内容 |
|--------|----------|
| **Update (RACE)** | JV-Link から過去データを取得 (32-bit Python) → 派生テーブルを更新 (64-bit) |
| **Suggest** | 複勝買い目提案を一括生成 (64-bit) |
| **Update + Suggest** | Update → Suggest を連続して実行 |
| **キャンセル** | 実行中のプロセスを停止してキューをクリア |

---

## 前提条件

| 要件 | 備考 |
|------|------|
| Windows | JV-Link COM コンポーネントが必要 |
| Python 32-bit | `jv_ingest_raw.py` は 32-bit で実行する必要あり |
| Python 64-bit venv | `pandas` / `catboost` 等のライブラリが入っている venv |
| JV-Link | `JVDTLab.JVLink` COM コンポーネントが登録済みであること |

---

## セットアップ

### 1. 64-bit venv に PySide6 をインストール

```powershell
# 64-bit venv をアクティブにしてから
pip install PySide6
```

依存関係は `requirements.txt` からまとめてインストールできます:

```powershell
pip install -r requirements.txt
```

### 2. 32-bit Python に pywin32 をインストール

```powershell
# 32-bit の python.exe を使って
C:\Python32\python.exe -m pip install pywin32
```

---

## 起動方法

```powershell
# リポジトリのルートディレクトリで
# 64-bit venv をアクティブにしてから
python gui/main.py
```

---

## 自動設定とデフォルト値

初回起動時 (設定ファイルが存在しない場合) に以下を自動で検出・設定します:

| 項目 | 自動設定内容 |
|------|-------------|
| DB パス | `<リポジトリルート>/jv_data.db` |
| モデルパス | `<リポジトリルート>/models/place_model.cbm` |
| 出力ディレクトリ | `<リポジトリルート>/out` (存在しない場合は自動作成) |
| 32-bit Python | `py` ランチャー または 一般的なインストールパスを自動検出 |

32-bit Python が自動検出できない場合は警告が表示されます。「検出」ボタンで再検出を試みるか、`…` ボタンで手動選択してください。

---

## 設定の永続化

設定はリポジトリルートの `.keiba_gui_config.json` に自動保存され、次回起動時に復元されます。  
このファイルはローカルの設定のみを含むため、`.gitignore` に登録されておりバージョン管理の対象外です。

保存される設定:
- DB パス / モデルパス / 出力ディレクトリ
- 32-bit Python コマンド
- 最後に使用した取込開始日
- レースキー
- 検索キーワード・週末メインレースフィルタ
- ウィンドウの位置とサイズ

---

## 各入力項目

| 項目 | デフォルト | 説明 |
|------|-----------|------|
| DB パス | `<repo>/jv_data.db` | SQLite DB ファイルのパス |
| 取込開始日 | 今日の日付 | カレンダーから選択。`YYYYMMDD` 形式で渡される。Update ボタン用 |
| 出力ディレクトリ | `<repo>/out` | Suggest の出力先ディレクトリ |
| モデルパス | `<repo>/models/place_model.cbm` | 学習済み CatBoost モデル |
| 32-bit Python | (自動検出) | 32-bit Python の実行コマンド。`py -3.11-32` または `python.exe` フルパス |
| レースキー (手動) | (空) | スペース区切りのレースキー。テーブルでレースを選択していない場合の手動フォールバック |

`…` ボタンを押すとファイル/フォルダ選択ダイアログが開きます。  
取込開始日はカレンダーアイコンをクリックしてカレンダーから選択できます。

---

## レース選択 (推奨ワークフロー)

レースキーを手入力する代わりに、GUI からレースを検索・選択できます。

### 重賞レースを素早く読み込む

1. **取込開始日** を対象レース日に設定します。
2. **「重賞レースを読み込む」** ボタンを押します。
   - `place_odds のみ` チェックボックスがオンの場合、place_odds データが存在するレースのみ表示されます (デフォルト: オン)。
   - grade_code A/B/C の重賞レースがテーブルに表示されます。

### キーワード・週末メインレースで検索する

1. **取込開始日** を対象レース日に設定します。
2. **「キーワード」** 欄にレース名の一部を入力します (空白でも検索可)。
3. 必要に応じて **「週末メイン (R≥10)」** チェックボックスをオンにします。
   - オンにすると race_no が 10 以上 (その日のメイン競走) のレースのみ表示されます。
4. **「検索」** ボタンを押します (またはキーワード欄で Enter キーを押します)。
5. テーブルの **✓ 列のチェックボックス** で対象レースを選択します (複数選択可)。
6. 下記いずれかで Suggest を実行します:
   - **そのまま「Suggest」または「Update + Suggest」を押す** — テーブルで選択中のレースキーが自動的に使われます。
   - **「選択したレースをキーに設定」** ボタンを押してレースキー欄に転記してから実行する。

テーブルで何も選択されていない場合は、「レースキー (手動)」欄の値が使用されます。

---

## 予想結果の確認 (インアプリビューア)

Suggest 実行後、出力ディレクトリの結果を GUI 内で確認できます。

### 自動更新

Suggest / Update+Suggest が正常完了すると、**予想結果セクションが自動的に更新**されます。

### 手動更新

「**結果を更新**」ボタンを押すと、出力ディレクトリの `summary.csv` を読み込んでサマリーテーブルを更新します。

### サマリーテーブルの見方

| 列 | 内容 |
|----|------|
| レース名 | DB のレース名 (取得できない場合は race_key) |
| 競馬場 | 競馬場コード |
| R | レース番号 |
| S | ステータス (ok / failed) |
| 買い目数 | 購入点数 |
| 賭金計 | 合計賭け金 |
| 期待値計 | 合計期待値 (円) |
| avg p | 平均複勝圏確率 |
| F/B | フォールバック使用フラグ |

### レースヘッダー

サマリーテーブルの行を選択すると、詳細エリアの上部に以下の情報を含む**レースヘッダーラベル**が表示されます:

```
日付  |  競馬場  |  R番号  |  レース名  |  グレード  |  距離(m)  |  馬場  |  出走N頭
```

DB から取得できない場合は race_key がそのまま表示されます。

### 詳細の確認

サマリーテーブルの行をクリックすると、選択レースの **買い目テーブル** と **予測テーブル** が下に展開されます。

### 買い目テーブルの表示/非表示

予測分析に集中したいときは「**買い目を隠す**」ボタンを押すと買い目テーブルを非表示にできます。再度押すと表示に戻ります。

### 予測テーブルの見方 (分析モード)

予測テーブルは p_place (複勝圏確率) **降順**で自動的にソートされます。DB に結果データがある場合、以下の追加列が表示されます:

| 列 | 内容 |
|----|------|
| 順位 | p_place 降順での予測ランク |
| 馬番 | 馬番号 |
| 馬ID | 馬のID |
| 騎手名 | 騎手名 (jockeys テーブルが利用可能な場合) |
| 調教師名 | 調教師名 (trainers テーブルが利用可能な場合) |
| p_place | 予測複勝圏確率 (4桁) |
| 着順 | 実際の着順 (結果が確定している場合) |
| 複勝圏 | ✓ = 実際に複勝圏入り / ✗ = 圏外 / (空) = 未確定 |
| TP | ✓ = 真陽性 (予測上位かつ実際に複勝圏入り)。行は**緑色**でハイライト |

### 分析用フィルタ・コントロール

予測テーブルの上部に以下のフィルタがあります:

| コントロール | 説明 |
|------------|------|
| **上位表示** (スピンボックス) | 0 = 全て表示 / N = 予測上位N頭のみ表示 (デフォルト: 8) |
| **複勝圏のみ** チェックボックス | 実際に複勝圏に入った馬のみ表示 (結果確定後の分析に便利) |
| **オッズあり馬のみ** チェックボックス | place_odds テーブルにオッズが存在する馬のみ表示 |

フィルタはリアルタイムで適用されます (ファイルの再読み込みは不要)。

### 出力フォルダを開く

「**出力フォルダを開く**」ボタンを押すと、OS のファイルマネージャーで出力ディレクトリが開きます。

---

## Update (RACE) の動作

1. **Step 1/2** — `scripts/jv_ingest_raw.py` を **32-bit Python** で実行:
   ```
   <python32> scripts/jv_ingest_raw.py --from-date <日付> --dataspec RACE --db <DB>
   ```
2. **Step 2/2** — `scripts/update_db_from_raw.py` を **64-bit Python (現在の venv)** で実行:
   ```
   python scripts/update_db_from_raw.py --db <DB> --skip-masters
   ```

Step 1 が失敗した場合、Step 2 は実行されません。

---

## Suggest の動作

`scripts/batch_suggest_place_bets.py` を **64-bit Python** で実行:

```
python scripts/batch_suggest_place_bets.py \
    --db <DB> --model <モデル> --out-dir <出力ディレクトリ> \
    --race-keys <レースキー1> <レースキー2> ...
```

出力 CSV は `<出力ディレクトリ>/summary.csv` に生成されます。  
各レースの予測 JSON は `pred_<race_key>.json`、買い目 JSON は `bets_<race_key>.json` として出力されます。

---

## ログ

ウィンドウ下部のログエリアに各コマンドの標準出力がリアルタイムで表示されます。  
「ログをクリア」ボタンでログを消去できます。
